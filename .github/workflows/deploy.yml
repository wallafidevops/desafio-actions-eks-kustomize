name: Deploy no kubernetes
on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
        description: 'Ambiente: use dev (→ hml) ou prod (→ prd) – ou passe hml/prd diretamente'

permissions:
  id-token: write
  contents: read
  security-events: write
  packages: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/wallafidevops/template-argocd-kustomize:0.1.0
      # credentials:
      #   username: ${{ github.actor }}
      #   password: ${{ secrets.GITHUB_TOKEN }}

    defaults:
      run:
        shell: '/bin/bash -eo pipefail {0}'

    environment: ${{ inputs.environment == 'hml' && 'dev' || inputs.environment == 'prd' && 'prod' || inputs.environment }}

    env:
      AWS_ECR_URI: 216989136189.dkr.ecr.us-east-1.amazonaws.com
      IMAGE_NAME: review-filmes
      ARGOCD_SERVER: argocd.app.wsnobrega.life
      ARGOCD_APP_NAME: review-filmes
      BRANCH_NAME: ${{ github.ref_name }}
      GIT_BOT_USER: github-actions[bot]
      GIT_BOT_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com

      STAGE: ${{ inputs.environment == 'dev' && 'hml' || inputs.environment == 'prod' && 'prd' || inputs.environment }}

    steps:
      - name: Checkout pipeline repo (source)
        uses: actions/checkout@v4

      - name: Configurar Git para BOT
        run: |
          git config --global user.name  "$GIT_BOT_USER"
          git config --global user.email "$GIT_BOT_EMAIL"

      - name: Atualizar imagem no overlay (${{ env.STAGE }})
        env:
          GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
          GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}
          STAGE: ${{ env.STAGE }}
          AWS_ECR_URI: ${{ env.AWS_ECR_URI }}
          IMAGE_NAME:  ${{ env.IMAGE_NAME }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        run: |
          set -euo pipefail

          rm -rf desafio-actions-eks-kustomize
          git clone "https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/wallafidevops/desafio-actions-eks-kustomize.git"

          cd desafio-actions-eks-kustomize

          git fetch origin "$BRANCH_NAME" || true
          git checkout "$BRANCH_NAME" || git checkout -b "$BRANCH_NAME"
          git pull origin "$BRANCH_NAME" || true

          OVERLAY_DIR="k8s/deploy/${STAGE}"
          test -d "$OVERLAY_DIR" || { echo "Overlay não encontrado: $OVERLAY_DIR"; exit 1; }

          SHORT_SHA="${GITHUB_SHA::7}"

          cd "$OVERLAY_DIR"

          kustomize edit set image \
            "$AWS_ECR_URI/placeholder=$AWS_ECR_URI/${STAGE}-${IMAGE_NAME}:${SHORT_SHA}"

          cd - >/dev/null

          if ! git diff --quiet -- "$OVERLAY_DIR/kustomization.yaml"; then
            git add "$OVERLAY_DIR/kustomization.yaml"
            git commit -m "[BOT] Atualiza imagem para ${AWS_ECR_URI}/${STAGE}-${IMAGE_NAME}:${SHORT_SHA}"
            git push origin "HEAD:${BRANCH_NAME}"
          else
            echo "Nenhuma mudança detectada."
          fi

      - name: Sincronizar com ArgoCD
        run: |
          set -euo pipefail
          argocd login "$ARGOCD_SERVER" --insecure --username admin --password "${{ secrets.ARGOCD_TOKEN }}" --grpc-web
          argocd app sync "$STAGE-$ARGOCD_APP_NAME" --force --prune --grpc-web

          